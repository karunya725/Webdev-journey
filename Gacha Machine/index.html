<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Christmas Advent Gacha</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c&display=swap');

    * ,
    *::before,
    *::after {
      box-sizing: border-box;
      font-family: inherit;
      padding: 0;
      margin: 0;
    }

    html {
      font-size: 62.5%;
      height: 100%;
      color: white;
      font-family: 'M PLUS Rounded 1c', 'Trebuchet MS', 'Lucida Sans Unicode',
        'Lucida Grande', 'Lucida Sans', Arial, sans-serif;
    }

    html body {
      font-size: 1.6rem;
      overflow: hidden;
      height: 100%;
      position: relative;
      user-select: none;
    }

    .confetti {
      position: absolute;
      top: 0;
      left: 0;
      overflow: hidden;
      width: 100%;
      height: 100%;
      z-index: 10;
      pointer-events: none;
      perspective: 100vmin;
    }

    .confetti span {
      --size: 5;
      display: block;
      position: absolute;
      width: calc(var(--size) * 1px);
      height: calc(var(--size) * 1px);
      background-color: blue;
      animation: rotate linear calc(var(--rs) * 1s) infinite both;
    }

    #app.gotcha {
      width: 100%;
      height: 100%;
      position: relative;
      background-color: #666;
    }

    #app.gotcha .container {
      width: 100%;
      height: 100%;
      overflow: hidden;
      position: relative;
    }

    #app.gotcha .game-layer {
      width: 100%;
      height: 100%;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      background: #bfe6ff;
      background-image: url("https://media.githubusercontent.com/media/karunya725/Webdev-journey/main/Gacha%20Machine/assets/background.png");
      background-repeat: no-repeat;
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }

    #app.gotcha .machine-container {
      position: relative;
      white-space: nowrap;
      top: 8%;
    }

    /* BACK MACHINE LAYER (behind gifts and front machine) */
    #app.gotcha .machine-container .machine-back {
      position: absolute;
      bottom: 0;              /* align bottom with front machine */
      left: 50%;
      transform: translateX(-50%);
      max-height: 72vh;
      pointer-events: none;
      z-index: 0;             /* furthest back */
      display: block;
    }

    #app.gotcha .machine-container .machine {
      position: relative;
      z-index: 3;              /* front-most machine art */
      max-height: 76vh;
      pointer-events: none;
      display: block;
    }

    #app.gotcha .machine-container .machinegif {
      position: absolute;
      bottom: 37%;              /* align bottom with front machine */
      left: 48%;
      transform: translateX(-50%);
      max-height: 66vh;
      pointer-events: none;
      z-index: 5;             /* furthest back */
      display: block;
    }

    #app.gotcha .machine-container .backboard {
      z-index: 0;
      width: 15vh;
      height: 13vh;
      top: 65%;
      left: 48%;
      background-color: rgb(179, 139, 87);
      position: absolute;
    }

    #app.gotcha .machine-container .title {
      --stroke-color: #ad8bd6;
      position: absolute;
      display: block;
      top: 10%;
      width: 100%;
      text-align: center;
      font-size: 5vh;
      z-index: 3;
      text-shadow:
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white);
      filter: drop-shadow(0px 2px 0px rgba(0, 0, 0, 0.2));
    }

    #app.gotcha .machine-container .price {
      z-index: 3;
      position: absolute;
      color: #fb91c9;
      font-size: 2.5vh;
      top: 80%;
      left: 15%;
    }

    /* knob */
    #app.gotcha .machine-container .handle {
      z-index: 4;
      position: absolute;
      height: 2.5vh;
      left: 21.75%;
      top: 69.75%;
    }

    /* REGION WHERE BALLS LIVE INSIDE THE GLASS */
    #app.gotcha .machine-container .balls {
      position: absolute;
      top: 8.5%;
      left: 14%;
      width: 73%;
      height: 50%;
      z-index: 2;   /* between back and front machine */
    }

    #app.gotcha .ui-layer {
      width: 100%;
      height: 100%;
      overflow: hidden;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
      pointer-events: none;
    }

    #app.gotcha .ui-layer .title-container {
      width: 100%;
      height: 100%;
      overflow: hidden;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 10;
    }

    #app.gotcha .ui-layer .title-container .title h2 {
      --stroke-color: #f06e5b;
      text-align: center;
      font-size: 5vh;
      text-shadow:
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white),
        0px 0px 2px var(--stroke-color, white);
      filter: drop-shadow(0px 2px 0px rgba(0, 0, 0, 0.2));
    }

    #app.gotcha .ui-layer .prize-container {
      width: 100%;
      height: 100%;
      overflow: hidden;
      position: absolute;
      top: 0;
      left: 0;
    }

    #app.gotcha .ui-layer .prize-container .prize-ball-container {
      width: 100%;
      height: 100%;
      overflow: hidden;
      position: absolute;
      top: 0;
      left: 0;
    }

    #app.gotcha .ui-layer .prize-container .prize-reward-container {
      width: 100%;
      height: 100%;
      overflow: hidden;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
      pointer-events: none;
    }

    #app.gotcha .ui-layer .prize-container .prize-reward-container .shine,
    #app.gotcha .ui-layer .prize-container .prize-reward-container .prize {
      display: block;
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #app.gotcha
      .ui-layer
      .prize-container
      .prize-reward-container
      .shine
      img {
      height: 100vh;
      /* animation: spin linear 5s infinite forwards; */
    }

    /* Bigger popup card */
    .prize .card {
      background: rgba(255, 255, 255, 0.97);
      border-radius: 2rem;
      padding: 2.4rem;
      box-shadow: 0 1rem 3rem rgba(0, 0, 0, 0.28);
      width: min(90vw, 520px);
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.6rem;
      color: #444;
    }

    .card-number {
      font-size: 3.2vh;
      color: #ff7ab5;
      text-shadow: 0 0.2rem 0 rgba(255, 255, 255, 0.8);
    }

    .card-image {
      max-height: 40vh;
      width: 100%;
      object-fit: contain;
      border-radius: 1.2rem;
    }

    .card-notes {
      width: 100%;
      min-height: 10rem;
      border-radius: 1rem;
      border: 1px solid #ffd1ea;
      padding: 1rem;
      font-size: 1.4rem;
      resize: vertical;
      font-family: inherit;
      outline: none;
    }

    .card-notes:focus {
      box-shadow: 0 0 0 2px #ffb3dd;
    }

    /* GIFT BOXES */
    #app.gotcha .container .ball {
      --size: 10vh;
      width: var(--size);
      height: var(--size);
      position: absolute;
      overflow: visible;
    }

    #app.gotcha .container .ball img.ball-img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }

    #app.gotcha .wiggle {
      animation: wiggle 2s ease-in-out infinite both;
    }

    .tap-to-close {
      position: absolute;
      bottom: 8vh;
      left: 50%;
      transform: translateX(-50%);
      font-size: 2vh;
      color: antiquewhite;
      text-shadow: 0 0 4px #c496569a;
      pointer-events: auto;
      padding: 0.8rem 1.6rem;
      border-radius: 999px;
      background: #c496566e;
      cursor: pointer;
      white-space: nowrap;
    }

    @keyframes wiggle {
      0%   { transform: rotate(-5deg); }
      50%  { transform: rotate(5deg); }
      100% { transform: rotate(-5deg); }
    }

    @keyframes spin {
      to   { transform: rotate(0turn); }
      from { transform: rotate(1turn); }
    }

    @keyframes rotate {
      from { transform: rotate3d(var(--rx), var(--ry), var(--rz), 0turn); }
      to   { transform: rotate3d(var(--rx), var(--ry), var(--rz), 1turn); }
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="container">
      <div class="game-layer">
        <div class="machine-container">
          <div class="backboard"></div>

          <!-- NEW back layer image -->
          <img
            class="machine-back"
            src="assets/machine/machinev2_back1.svg"
            alt="Machine backing"
          />

          <div class="balls"></div>

          <!-- front machine -->
          <img
            class="machine"
            src="assets/machine/machinev2.1_front.svg"
            alt="Machine front"
          />

          <img
            class="machinegif"
            src="./assets/animations/topmachinev1.gif"
            alt="Machine front"
          />
          <div class="title"></div>
          <div class="price"></div>

          <!-- knob -->
          <img
            class="handle"
            src="assets/machine/knob.svg"
            alt="Machine knob"
          />
        </div>
      </div>

      <div class="ui-layer">
        <div class="title-container">
          <div class="title"></div>
        </div>
        <div class="prize-container">
          <div class="prize-ball-container"></div>
          <div class="prize-reward-container">
            <div class="shine">
              <!-- <img src="./assets/animations/starssparkle.gif" /> -->
            </div>
            <div class="prize">
              <div class="card">
                <h2 class="card-number">Card ?</h2>
                <img class="card-image" src="" alt="Prize image" />
                <textarea
                  class="card-notes"
                  placeholder="Write something about this card..."
                ></textarea>
              </div>
            </div>
            <div class="tap-to-close">Tap here to close</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- GSAP + EasePack -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/EasePack.min.js"></script>

  <script>
    const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

    const confetti = (
      $parent,
      {
        count = 100,
        x = 50,
        y = 50,
        randX = 10,
        randY = 10,
        speedX = 0,
        speedY = -2,
        speedRandX = 0.5,
        speedRandY = 0.5,
        gravity = 0.01,
        size = 10,
        sizeRand = 5
      } = {}
    ) => {
      const $container = document.createElement('div');
      $container.classList.add('confetti');

      const particles = [];

      for (let i = 0; i < count; i++) {
        const $particle = document.createElement('span');

        const settings = {
          dom: $particle,
          x: x + Math.random() * randX * 2 - randX,
          y: y + Math.random() * randY * 2 - randY,
          speedX: speedX + Math.random() * speedRandX * 2 - speedRandX,
          speedY: speedY + Math.random() * speedRandY * 2 - speedRandY,
          size: size + Math.random() * sizeRand * 2 - sizeRand
        };

        $particle.style.backgroundColor = `hsl(${
          Math.random() * 360
        }deg, 80%, 60%)`;
        $particle.style.setProperty('--rx', Math.random() * 2 - 1);
        $particle.style.setProperty('--ry', Math.random() * 2 - 1);
        $particle.style.setProperty('--rz', Math.random() * 2 - 1);
        $particle.style.setProperty('--rs', Math.random() * 2 + 0.5);
        particles.push(settings);
        $container.appendChild($particle);
      }

      const update = () => {
        particles.forEach((config, i) => {
          if (config.y > 100) {
            particles.splice(i, 1);
            config.dom.remove();
          }

          config.dom.style.setProperty('--size', config.size);
          config.dom.style.left = config.x + '%';
          config.dom.style.top = config.y + '%';
          config.x += config.speedX;
          config.y += config.speedY;
          config.speedY += gravity;
        });

        if (particles.length) {
          requestAnimationFrame(update);
        } else {
          $container.remove();
        }
      };

      update();

      $parent.insertAdjacentElement('beforeend', $container);
    };

    const TOTAL_PRIZES = 25;
    const STORAGE_KEY = 'gotchaUsedPrizes';

    const loadUsedPrizes = () => {
      try {
        const s = localStorage.getItem(STORAGE_KEY);
        if (!s) return [];
        const arr = JSON.parse(s);
        if (!Array.isArray(arr)) return [];
        return arr
          .map(n => Number(n))
          .filter(n => Number.isInteger(n) && n >= 0 && n < TOTAL_PRIZES);
      } catch (e) {
        return [];
      }
    };

    const saveUsedPrizes = arr => {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    };

    let usedPrizeIndices = loadUsedPrizes();

    const prizes = Array.from({ length: TOTAL_PRIZES }, (_, i) => ({
      image: `assets/prize${i + 1}.png`,
      number: i + 1
    }));

    const getPrize = () => {
      let used = loadUsedPrizes();
      if (used.length >= TOTAL_PRIZES) {
        used = [];
      }
      const nextIndex = used.length;
      used.push(nextIndex);
      saveUsedPrizes(used);
      usedPrizeIndices = used;
      return { ...prizes[nextIndex], index: nextIndex };
    };

    let balls = [],
      started = false,
      prizeBall;
    let $app, $machine, $handle, $balls, $title;
    let $$jitters = [];
    let prize = null;
    const SPEED = 1;

    const init = () => {
      $app = document.querySelector('#app');
      $app.classList.add('gotcha');

      const TITLE_TEXT = '';
      const PRICE = '';

      $machine = document.querySelector('.machine-container');
      $handle = document.querySelector('.machine-container .handle');
      $balls = document.querySelector('.machine-container .balls');
      $title = document.querySelector('.title-container .title');

      gsap.set($handle, {
        transformOrigin: '50% 50%'
      });

      $machine.querySelector('.title').innerHTML = '';
      $machine.querySelector('.price').innerText = PRICE;

      createBalls();

      gsap.set($machine, { y: '0vh' });
      gsap.set($title, { y: '120vh' });
      gsap.set('.prize-reward-container', { opacity: 0 });

      setTimeout(prepare, 500 * SPEED);
    };

    const prepare = () => {
      $handle.style.cursor = 'pointer';
      $handle.addEventListener('click', start, { once: true });

      balls.forEach(ball => {
        const tl = gsap.timeline();
        const duration = 0.05 + Math.random() * 0.1;

        tl.to(ball.dom, {
          y: -(10 + Math.random() * 10),
          ease: 'power1.out',
          duration
        }).to(ball.dom, {
          y: 0,
          duration,
          ease: 'power1.in'
        });
      });
    };

    const start = async () => {
      prize = getPrize();

      $handle.style.cursor = 'default';
      started = true;

      await new Promise(resolve => {
        const tl = gsap.timeline();
        tl.to($handle, {
          rotate: 90,
          duration: 0.3,
          ease: 'power1.in',
          async onComplete() {
            jitter();
            await delay(2000 * SPEED);
            await stopJittering();
            resolve();
          }
        }).to($handle, {
          rotate: 0,
          duration: 1
        });
      });

      if (prizeBall) {
        const boxImg = prizeBall.dom.querySelector('.ball-img');
        if (boxImg) {
          // https://media.githubusercontent.com/media/karunya725/Webdev-journey/main/Gacha%20Machine/assets/ballsTiny/1.png
          // boxImg.src = `assets/ballsTiny/${prize.number}.png`;
          // boxImg.src = `https://media.githubusercontent.com/media/karunya725/Webdev-journey/main/Gacha%20Machine/assets/ballsTiny/${prize.number}.png`;
          boxImg.src = `assets/giftboxes/${prize.number}.svg`;
        }
      }

      await new Promise(resolve => {
        const tl = gsap.timeline();

        gsap.to(prizeBall.dom, {
          x: '-3vh',
          ease: 'none',
          duration: 0.5
        });

        if (balls[3]) {
          gsap.to(balls[3].dom, {
            x: '1vh',
            y: '1vh',
            ease: 'none',
            duration: 0.5
          });
        }
        if (balls[4]) {
          gsap.to(balls[4].dom, {
            x: '-1vh',
            y: '1vh',
            ease: 'none',
            duration: 0.5
          });
        }
        if (balls[5]) {
          gsap.to(balls[5].dom, {
            x: '1vh',
            y: '1vh',
            ease: 'none',
            duration: 0.5
          });
        }

        const totalDropTime = 0.5 + 0.5 + 0.2 + 0.2 + 0.1 + 0.1;

        gsap.to(prizeBall.dom, {
          rotation: 0,
          duration: totalDropTime,
          ease: 'power2.out'
        });

        tl.to(prizeBall.dom, {
          y: '15vh',
          ease: 'power1.in',
          duration: 0.5
        })
          .to(prizeBall.dom, {
            y: '22vh',
            ease: 'power1.in',
            duration: 0.5
          })
          .to(prizeBall.dom, {
            y: '19vh',
            ease: 'power1.out',
            duration: 0.2
          })
          .to(prizeBall.dom, {
            y: '22vh',
            ease: 'power1.in',
            duration: 0.2
          })
          .to(prizeBall.dom, {
            y: '21vh',
            ease: 'power1.out',
            duration: 0.1
          })
          .to(prizeBall.dom, {
            y: '22vh',
            ease: 'power1.in',
            duration: 0.1,
            onComplete: resolve
          });
      });

      prizeBall.dom.style.cursor = 'pointer';

      prizeBall.dom.addEventListener(
        'click',
        () => {
          prizeBall.dom.style.cursor = 'default';
          pickup();
        },
        { once: true }
      );
    };

    const pickup = () => {
      let { x, y } = prizeBall.dom.getBoundingClientRect();
      [x, y] = [x / window.innerHeight * 100, y / window.innerHeight * 100];
      document
        .querySelector('.prize-container .prize-ball-container')
        .appendChild(prizeBall.dom);

      prizeBall.dom.style.width = '10vh';
      prizeBall.dom.style.height = '10vh';
      prizeBall.dom.style.setProperty('--size', '10vh');

      prizeBall.x = 0;
      prizeBall.y = 0;

      prizeBall.dom.style.left = 0;
      prizeBall.dom.style.top = 0;

      gsap.set(prizeBall.dom, {
        x: `${x}vh`,
        y: `${y}vh`,
        rotation: 0,
        duration: 1
      });

      gsap.to('.prize-container .prize-ball-container', {
        x: `-4vh`,
        y: `-4vh`,
        duration: 1
      });

      let tl = gsap.timeline();
      tl.to(prizeBall.dom, {
        x: '50vw',
        y: '50vh',
        scale: 2,
        rotation: 360,
        duration: 1
      })
        .to(prizeBall.dom, {
          duration: 0.1,
          scaleX: 2.1,
          ease: 'power1.inOut',
          scaleY: 1.9
        })
        .to(prizeBall.dom, {
          duration: 0.1,
          ease: 'power1.inOut',
          scaleX: 1.9,
          scaleY: 2.1
        })
        .to(prizeBall.dom, {
          duration: 0.1,
          ease: 'power1.inOut',
          scaleX: 2.1,
          scaleY: 1.9
        })
        .to(prizeBall.dom, {
          duration: 0.1,
          ease: 'power1.inOut',
          scaleX: 1.9,
          scaleY: 2.1
        })
        .to(prizeBall.dom, {
          duration: 0.1,
          ease: 'power1.inOut',
          scaleX: 2.1,
          scaleY: 1.9
        })
        .to(prizeBall.dom, {
          duration: 0.1,
          ease: 'power1.inOut',
          scaleX: 1.9,
          scaleY: 2.2
        })
        .to(prizeBall.dom, {
          duration: 0.5,
          ease: 'power1.out',
          scaleX: 2.6,
          scaleY: 1.6
        })
        .to(prizeBall.dom, {
          duration: 0.1,
          ease: 'power1.out',
          scaleX: 1.6,
          scaleY: 2.4,
          onComplete: pop
        })
        .to(prizeBall.dom, {
          duration: 0.1,
          ease: 'power1.out',
          scaleX: 2.1,
          scaleY: 1.9
        })
        .to(prizeBall.dom, {
          duration: 0.1,
          ease: 'power1.out',
          scaleX: 2,
          scaleY: 2
        });
    };

    const closePrizeOverlay = () => {
      const overlay = document.querySelector('.prize-reward-container');
      if (overlay) overlay.style.pointerEvents = 'none';

      gsap.to('.prize-reward-container', { opacity: 0, duration: 0.4 });

      setTimeout(() => {
        location.reload();
      }, 450);
    };

    const pop = () => {
      const cardImg = document.querySelector('.card-image');
      const cardNum = document.querySelector('.card-number');

      if (prize) {
        if (cardImg) {
          cardImg.src = prize.image;
          cardImg.style.display = 'block';
        }
        if (cardNum) {
          cardNum.textContent = `Card ${prize.number}`;
        }
      }

      confetti($app, {
        speedX: 0,
        speedY: -0.5,
        speedRandY: 1,
        speedRandX: 0.75,
        gravity: 0.02,
        y: 50,
        randX: 6,
        randY: 6,
        size: 8,
        sizeRand: 4,
        count: 128
      });

      gsap.to(prizeBall.dom, { opacity: 0 });

      $title.innerHTML = '';
      gsap.set('.title-container', { opacity: 0 });

      gsap.set('.prize-reward-container .prize', { scale: 0 });
      gsap.to('.prize-reward-container', { opacity: 1, duration: 0.3 });
      gsap.to('.prize-reward-container .prize', {
        scale: 1,
        duration: 0.5,
        ease: 'back.out'
      });

      const overlay = document.querySelector('.prize-reward-container');
      if (overlay) overlay.style.pointerEvents = 'auto';

      const closeBtn = document.querySelector('.tap-to-close');
      if (closeBtn) {
        closeBtn.onclick = e => {
          e.stopPropagation();
          closePrizeOverlay();
        };
      }
    };

    const createBalls = () => {
      const BALL_COUNT = 25;
      const cols = 5;
      const rows = 5;
      const fibPositions = new Set([1, 2, 3, 5, 8, 13, 21]);

      let id = 0;

      const imageOrder = Array.from({ length: BALL_COUNT }, (_, i) => i + 1);
      for (let i = imageOrder.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [imageOrder[i], imageOrder[j]] = [imageOrder[j], imageOrder[i]];
      }

      const createBall = (x, y, rotate, imageUrl, sizeVh) => {
        const $ball = document.createElement('figure');
        $ball.classList.add('ball');
        $ball.setAttribute('data-id', ++id);

        $ball.style.setProperty('--size', `${sizeVh}vh`);

        const img = document.createElement('img');
        img.src = imageUrl;
        img.alt = 'Gift box';
        img.classList.add('ball-img');
        $ball.appendChild(img);

        $balls.appendChild($ball);

        const update = () => {
          gsap.set($ball, {
            css: {
              left: `calc(${x} * (100% - ${sizeVh}vh))`,
              top: `calc(${y} * (100% - ${sizeVh}vh))`,
              rotation: rotate
            }
          });
        };

        const ball = {
          dom: $ball,
          get x() { return x; },
          get y() { return y; },
          get rotate() { return rotate; },
          set x(value) { x = value; update(); },
          set y(value) { y = value; update(); },
          set rotate(value) { rotate = value; update(); },
          get size() { return sizeVh; }
        };

        balls.push(ball);
        update();
        return ball;
      };

      for (let i = 0; i < BALL_COUNT; i++) {
        const row = Math.floor(i / cols);
        const col = i % cols;

        const x = 0.02 + (col / (cols - 1)) * 0.96;
        const y = 0.1 + (row / (rows - 1)) * 0.8;
        const rotate = Math.random() * 360;

        const imageIndex = imageOrder[i];
        // const imageUrl = `assets/ballsTiny/${imageIndex}.png`;
        // const imageUrl = `https://media.githubusercontent.com/media/karunya725/Webdev-journey/main/Gacha%20Machine/assets/ballsTiny/${imageIndex}.png`;
        const imageUrl = `assets/giftboxes/${imageIndex}.svg`;

        const positionIndex = i + 1;
        const baseSize = 11;
        let sizeVh = baseSize;

        if (fibPositions.has(positionIndex)) {
          const shrink = 0.1 + Math.random() * 0.4;
          sizeVh = baseSize * (1 - shrink);
        }

        const ball = createBall(x, y, rotate, imageUrl, sizeVh);

        if (i === BALL_COUNT - 1) {
          prizeBall = ball;
        }
      }
    };

    const jitter = () => {
      balls.forEach(({ dom, rotate }, i) => {
        const tl = gsap.timeline({ repeat: -1, delay: -i * 0.0613 });

        gsap.set(dom, { y: 0, rotation: rotate });

        const duration = Math.random() * 0.1 + 0.05;

        tl.to(dom, {
          y: -(Math.random() * 6 + 2),
          rotation: rotate + (Math.random() * 10 - 5),
          duration,
          ease: RoughEase.ease.config({
            template: Power0.easeOut,
            strength: 1,
            points: 20,
            taper: 'none',
            randomize: true,
            clamp: false
          })
        }).to(dom, {
          y: 0,
          rotation: rotate,
          duration
        });

        $$jitters.push(tl);
      });

      const tl = gsap.timeline({ repeat: -1 });
      tl.to('.machine-container', { x: 2, duration: 0.1 })
        .to('.machine-container', { x: 0, duration: 0.1 });

      $$jitters.push(tl);
    };

    const stopJittering = async () => {
      $$jitters.forEach($$jitter => $$jitter.pause());

      balls.forEach(({ dom, rotate }) => {
        gsap.to(dom, { y: 0, rotation: rotate, duration: 0.1 });
      });

      gsap.to('.machine-container', { x: 0, duration: 0.1 });

      await delay(200);
    };

    init();
  </script>
</body>
</html>
